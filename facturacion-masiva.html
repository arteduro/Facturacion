<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes"/>
  <title>Facturaci√≥n Masiva - Brisas del Norte</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #eef2f6;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: #1e3c5c;
      color: white;
      padding: 15px 20px;
      border-radius: 10px 10px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header h1 {
      font-size: 1.5rem;
    }

    .header h1 span {
      font-size: 0.9rem;
      font-weight: 300;
      display: block;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 30px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-primary {
      background: #1e3c5c;
      color: white;
      border: 1px solid #FFD700;
    }

    .btn-success {
      background: #1f7b4d;
      color: white;
    }

    .btn-warning {
      background: #dd9220;
      color: white;
    }

    .btn-danger {
      background: #c62828;
      color: white;
    }

    .btn-menu {
      background: #FFD700;
      color: #1e3c5c;
    }

    .btn-pdf {
      background: #d32f2f;
      color: white;
    }

    .btn-excel {
      background: #2e7d32;
      color: white;
    }

    .btn-zip {
      background: #7b1fa2;
      color: white;
    }

    .btn-impresion {
      background: #d32f2f;
      color: white;
      font-size: 1.2rem;
      padding: 15px 30px;
    }

    .card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      background: #f8fafd;
      padding: 12px 15px;
      border-bottom: 2px solid #1e3c5c;
      font-weight: 600;
      color: #1e3c5c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .card-body {
      padding: 20px;
    }

    .upload-area {
      border: 2px dashed #cbdbe9;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      background: #f8fafd;
      cursor: pointer;
      transition: all 0.3s;
    }

    .upload-area:hover {
      border-color: #1e3c5c;
      background: #e8f0fe;
    }

    .upload-area i {
      font-size: 48px;
      color: #1e3c5c;
      margin-bottom: 10px;
    }

    .file-types {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .file-type-badge {
      background: rgba(30,60,92,0.1);
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #1e3c5c;
      border: 1px solid #1e3c5c;
    }

    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .config-item {
      display: flex;
      flex-direction: column;
    }

    .config-item label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #2c4c6b;
      margin-bottom: 3px;
    }

    .config-item input,
    .config-item select {
      padding: 8px;
      border: 1px solid #d0dfee;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .progress-bar {
      width: 100%;
      height: 25px;
      background: #e9ecef;
      border-radius: 12px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #d32f2f, #b71c1c);
      width: 0%;
      transition: width 0.3s;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 10px 0;
    }

    .stat-card {
      background: #f8fafd;
      border: 1px solid #cbdbe9;
      border-radius: 5px;
      padding: 10px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e3c5c;
    }

    .stat-label {
      font-size: 0.7rem;
      color: #4a6d8c;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 20px 0;
      justify-content: center;
    }

    .action-buttons .btn {
      flex: 1;
      min-width: 150px;
      padding: 12px 20px;
      font-size: 1rem;
    }

    .success-message {
      background: #e8f5e8;
      color: #2e7d32;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      text-align: center;
      font-size: 1.1rem;
      border-left: 4px solid #2e7d32;
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid #d0dfee;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 5px;
    }

    .tab {
      padding: 8px 16px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }

    .tab.active {
      border-bottom-color: #1e3c5c;
      color: #1e3c5c;
      font-weight: 600;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      border-radius: 10px;
      max-width: 900px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      background: #1e3c5c;
      color: white;
      padding: 15px;
      border-radius: 10px 10px 0 0;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-footer {
      padding: 15px;
      text-align: right;
      border-top: 1px solid #d0dfee;
    }

    @media (max-width: 768px) {
      .header { flex-direction: column; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .tab { padding: 5px 10px; font-size: 0.8rem; }
      .action-buttons .btn { min-width: 100%; }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üì¶ FACTURACI√ìN MASIVA <span>Brisas del Norte</span></h1>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <a href="index.html" class="btn btn-menu">üè† MEN√ö PRINCIPAL</a>
      <a href="factura-individual.html" class="btn btn-primary">üßæ FACTURA INDIVIDUAL</a>
    </div>
  </div>

  <!-- Pesta√±as -->
  <div class="tabs">
    <div class="tab active" onclick="showTab('cargar')">üì§ 1. Cargar Novedades</div>
    <div class="tab" onclick="showTab('procesar')">‚öôÔ∏è 2. Procesar Facturaci√≥n</div>
    <div class="tab" onclick="showTab('generar')">üñ®Ô∏è 3. GENERAR FACTURAS PDF</div>
  </div>

  <!-- Pesta√±a 1: Cargar Novedades -->
  <div id="tab-cargar" class="card">
    <div class="card-header">
      <span>üì§ Cargar archivo de novedades</span>
      <div class="file-types">
        <span class="file-type-badge">üìä Excel (.xlsx, .xls)</span>
        <span class="file-type-badge">üìÑ CSV (.csv)</span>
        <span class="file-type-badge">üìù TXT (.txt)</span>
      </div>
    </div>
    <div class="card-body">
      <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <div style="font-size: 48px;">üìÇ</div>
        <h3>Haga clic para cargar archivo</h3>
        <p style="color: #4a6d8c;">Formatos aceptados: .xlsx, .xls, .csv, .txt</p>
        <p style="color: #4a6d8c; font-size: 0.8rem; margin-top: 10px;">
          Formato: propietario,direccion,pago_mes,cuota_extra,sanciones,acuerdo_pago,observaciones
        </p>
        <input type="file" id="fileInput" style="display: none;" accept=".xlsx,.xls,.csv,.txt" onchange="handleFileUpload(event)">
      </div>

      <div id="fileInfo" style="display: none; margin-top: 20px;">
        <h4>Archivo cargado: <span id="fileName"></span></h4>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalRegistros">0</div>
            <div class="stat-label">Total registros</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="propietariosEncontrados">0</div>
            <div class="stat-label">Propietarios encontrados</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="propietariosNoEncontrados">0</div>
            <div class="stat-label">No encontrados</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalFacturar">$0</div>
            <div class="stat-label">Total a facturar</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pesta√±a 2: Procesar Facturaci√≥n -->
  <div id="tab-procesar" style="display: none;" class="card">
    <div class="card-header">
      <span>‚öôÔ∏è Configuraci√≥n de facturaci√≥n</span>
    </div>
    <div class="card-body">
      <div class="config-grid">
        <div class="config-item">
          <label>üìÖ Mes a facturar</label>
          <select id="mesFacturacion">
            <option value="1">Enero 2026</option>
            <option value="2">Febrero 2026</option>
            <option value="3" selected>Marzo 2026</option>
            <option value="4">Abril 2026</option>
            <option value="5">Mayo 2026</option>
            <option value="6">Junio 2026</option>
            <option value="7">Julio 2026</option>
            <option value="8">Agosto 2026</option>
            <option value="9">Septiembre 2026</option>
            <option value="10">Octubre 2026</option>
            <option value="11">Noviembre 2026</option>
            <option value="12">Diciembre 2026</option>
          </select>
        </div>
        <div class="config-item">
          <label>üí∞ Cuota adm√≥n fija</label>
          <input type="number" id="cuotaAdmonFija" value="100000" readonly>
        </div>
        <div class="config-item">
          <label>üìÑ N¬∞ Factura inicial</label>
          <input type="number" id="facturaInicial" value="5000">
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="procesarFacturacion()">üîÑ PROCESAR FACTURACI√ìN</button>
        <button class="btn btn-warning" onclick="simularFacturacion()">üîç Simular</button>
      </div>

      <div id="progressContainer" style="display: none;">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <p id="progressText">Procesando 0/0 facturas...</p>
      </div>

      <div id="resultadosProceso" style="display: none;">
        <div class="success-message">
          ‚úÖ ¬°Facturaci√≥n procesada exitosamente!
        </div>
        
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="facturasGeneradas">0</div>
            <div class="stat-label">Facturas listas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalFacturado">$0</div>
            <div class="stat-label">Total facturado</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pesta√±a 3: GENERAR FACTURAS PDF -->
  <div id="tab-generar" style="display: none;" class="card">
    <div class="card-header" style="background: #d32f2f; color: white;">
      <span>üñ®Ô∏è GENERAR FACTURAS PDF</span>
      <span class="badge badge-warning">Total: <span id="totalFacturasGenerar">0</span> facturas</span>
    </div>
    <div class="card-body">
      <div class="stats" style="margin-bottom: 20px;">
        <div class="stat-card">
          <div class="stat-value" id="totalFacturasDisp">0</div>
          <div class="stat-label">Facturas disponibles</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalValorDisp">$0</div>
          <div class="stat-label">Valor total</div>
        </div>
      </div>

      <!-- Bot√≥n principal -->
      <div style="text-align: center; margin: 30px 0;">
        <button class="btn btn-impresion" onclick="generarTodasLasFacturas()" style="background: #d32f2f; font-size: 1.5rem; padding: 20px 40px;">
          <span style="font-size: 2rem;">üñ®Ô∏è</span> GENERAR TODAS LAS FACTURAS EN PDF
        </button>
        <p style="color: #4a6d8c; margin-top: 15px;">
          Se generar√° un ZIP con TODAS las facturas (saldos desde Google Sheets)
        </p>
      </div>

      <!-- Barra de progreso -->
      <div id="generacionProgress" style="display: none; margin-top: 30px;">
        <h4 style="color: #1e3c5c;">Generando facturas...</h4>
        <div class="progress-bar" style="height: 30px;">
          <div class="progress-fill" id="generacionProgressFill" style="width: 0%; background: #d32f2f;"></div>
        </div>
        <p id="generacionProgressText" style="margin-top: 10px; font-weight: bold;">Preparando...</p>
        <p id="generacionProgressDetalle" style="color: #666;"></p>
      </div>

      <!-- Lista de facturas -->
      <div style="margin-top: 30px;">
        <h4 style="color: #1e3c5c;">Facturas generadas:</h4>
        <table id="tablaFacturas">
          <thead>
            <tr>
              <th>Factura N¬∞</th>
              <th>Propietario</th>
              <th>Manzana</th>
              <th>Interior</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="facturasBody">
            <tr>
              <td colspan="5" style="text-align: center; padding: 20px;">
                No hay facturas generadas. Primero procese la facturaci√≥n.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIGURACI√ìN SHEETDB =====
  const SHEETDB_APP_ID = 'u1isouefcaro1';
  const SHEETDB_TOKEN = 'fmqycvr0ty1ptkadi4s8kj9u6el99zlokcvzxqk5';
  const SHEETDB_URL_READ = `https://sheetdb.io/api/v1/${SHEETDB_APP_ID}`;
  const SHEETDB_URL_WRITE = `https://sheetdb.io/api/v1/${SHEETDB_APP_ID}?bearer_token=${SHEETDB_TOKEN}`;
  // ================================

  let propietariosData = [];
  let novedadesData = [];
  let facturasGeneradas = [];

  window.onload = function() {
    cargarPropietarios();
  };

  function showTab(tabName) {
    document.getElementById('tab-cargar').style.display = 'none';
    document.getElementById('tab-procesar').style.display = 'none';
    document.getElementById('tab-generar').style.display = 'none';
    
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    
    document.getElementById(`tab-${tabName}`).style.display = 'block';
    event.target.classList.add('active');
    
    if (tabName === 'generar') {
      cargarTablaFacturas();
    }
  }

  // ===== FUNCIONES SHEETDB =====
  async function cargarPropietarios() {
    try {
      // 1. Cargar propietarios desde JSON
      const response = await fetch('propietarios.json');
      propietariosData = await response.json();
      
      // 2. Cargar saldos desde SheetDB
      console.log('Cargando saldos desde SheetDB...');
      const saldosResponse = await fetch(SHEETDB_URL_READ);
      const saldosData = await saldosResponse.json();
      
      // 3. Crear un mapa de saldos por propietario
      const saldosMap = {};
      saldosData.forEach(row => {
        const key = `${row.propietario}_${row.manzana}_${row.interior}`;
        saldosMap[key] = parseFloat(row.saldo_anterior_febrero) || 0;
      });
      
      // 4. Asignar saldos a cada propietario
      propietariosData = propietariosData.map(p => {
        const key = `${p.propietario}_${p.manzana}_${p.interior}`;
        p.saldo_actual = saldosMap[key] || 0;
        p.historial_pagos = p.historial_pagos || [];
        return p;
      });
      
      console.log(`‚úÖ ${propietariosData.length} propietarios cargados`);
      console.log('Saldos cargados desde SheetDB');
      
    } catch (error) {
      console.error('Error cargando propietarios:', error);
      alert('Error cargando datos. Verifique la conexi√≥n con SheetDB.');
    }
  }

  async function guardarSaldos() {
    console.log('Guardando saldos en SheetDB...');
    
    // Preparar los datos para actualizar
    const updates = propietariosData.map(p => ({
      propietario: p.propietario || '',
      manzana: p.manzana || '',
      interior: p.interior || '',
      saldo_anterior_febrero: (p.saldo_actual || 0).toString(),
      mes: p.historial_pagos?.length > 0 
        ? p.historial_pagos[p.historial_pagos.length - 1].mes 
        : 'Febrero 2026',
      ultima_actualizacion: new Date().toISOString().split('T')[0]
    }));
    
    try {
      // SheetDB soporta actualizaci√≥n masiva con PATCH
      const response = await fetch(SHEETDB_URL_WRITE, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updates)
      });
      
      if (response.ok) {
        console.log('‚úÖ Saldos guardados en SheetDB');
      } else {
        const errorText = await response.text();
        console.error('Error guardando en SheetDB:', errorText);
      }
    } catch (error) {
      console.error('Error en guardarSaldos:', error);
    }
  }
  // =============================

  function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    document.getElementById('fileName').innerText = file.name;
    
    const fileExtension = file.name.split('.').pop().toLowerCase();
    
    if (fileExtension === 'txt') {
      const reader = new FileReader();
      reader.onload = function(e) {
        const contenido = e.target.result;
        procesarArchivoTXT(contenido);
      };
      reader.readAsText(file);
    } else {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          procesarNovedades(jsonData);
        } catch (error) {
          console.error('Error leyendo archivo:', error);
          alert('Error al leer el archivo. Verifique el formato.');
        }
      };
      reader.readAsArrayBuffer(file);
    }
  }

  function procesarArchivoTXT(contenido) {
    const lineas = contenido.split('\n').filter(linea => linea.trim() !== '');
    const headers = lineas[0].split(',').map(h => h.trim());
    
    const data = [];
    for (let i = 1; i < lineas.length; i++) {
      const valores = lineas[i].split(',').map(v => v.trim());
      const row = {};
      headers.forEach((header, index) => {
        row[header] = valores[index] || '';
      });
      data.push(row);
    }
    
    procesarNovedades(data);
  }

  function procesarNovedades(data) {
    novedadesData = data;
    
    document.getElementById('totalRegistros').innerText = data.length;
    
    let encontrados = 0;
    let noEncontrados = 0;
    let totalFacturar = 0;
    
    data.forEach(row => {
      const propietario = propietariosData.find(p => 
        p.propietario?.toLowerCase().includes(row.propietario?.toLowerCase() || '') ||
        `${p.manzana} ${p.interior}`.toLowerCase().includes(row.direccion?.toLowerCase() || '')
      );
      
      if (propietario) {
        encontrados++;
        totalFacturar += (parseFloat(row.cuota_extra) || 0) + 
                        (parseFloat(row.sanciones) || 0) + 
                        (parseFloat(row.acuerdo_pago) || 0);
      } else {
        noEncontrados++;
      }
    });
    
    document.getElementById('propietariosEncontrados').innerText = encontrados;
    document.getElementById('propietariosNoEncontrados').innerText = noEncontrados;
    document.getElementById('totalFacturar').innerText = '$' + totalFacturar.toLocaleString('es-CO');
    
    document.getElementById('fileInfo').style.display = 'block';
    mostrarVistaPreviaNovedades(data);
  }

  function mostrarVistaPreviaNovedades(data) {
    const tablaNovedades = document.createElement('div');
    tablaNovedades.innerHTML = '<h4>Vista previa de novedades:</h4>';
    
    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const tbody = document.createElement('tbody');
    
    if (data.length > 0) {
      const headerRow = document.createElement('tr');
      Object.keys(data[0]).forEach(key => {
        const th = document.createElement('th');
        th.innerText = key;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      
      data.slice(0, 5).forEach(row => {
        const tr = document.createElement('tr');
        Object.values(row).forEach(val => {
          const td = document.createElement('td');
          td.innerText = val;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    
    table.appendChild(thead);
    table.appendChild(tbody);
    tablaNovedades.appendChild(table);
    
    const fileInfoDiv = document.getElementById('fileInfo');
    const existingPreview = document.getElementById('vistaPreviaNovedades');
    if (existingPreview) existingPreview.remove();
    
    tablaNovedades.id = 'vistaPreviaNovedades';
    fileInfoDiv.appendChild(tablaNovedades);
  }

  async function procesarFacturacion() {
    if (novedadesData.length === 0) {
      alert('Primero debe cargar un archivo de novedades.');
      showTab('cargar');
      return;
    }
    
    const mes = document.getElementById('mesFacturacion').value;
    const facturaInicial = parseInt(document.getElementById('facturaInicial').value);
    const cuotaBase = 100000;
    
    const nombresMeses = [
      'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
    ];
    const nombreMes = nombresMeses[parseInt(mes) - 1] + ' 2026';
    
    document.getElementById('progressContainer').style.display = 'block';
    facturasGeneradas = [];
    
    let procesadas = 0;
    const total = novedadesData.length;
    const startTime = Date.now();
    
    const interval = setInterval(() => {
      if (procesadas < total) {
        const row = novedadesData[procesadas];
        const propietario = propietariosData.find(p => 
          p.propietario?.toLowerCase().includes(row.propietario?.toLowerCase() || '') ||
          `${p.manzana} ${p.interior}`.toLowerCase().includes(row.direccion?.toLowerCase() || '')
        );
        
        if (propietario) {
          // Asegurar que el propietario tenga los campos de saldo
          if (!propietario.saldo_actual) propietario.saldo_actual = 0;
          if (!propietario.historial_pagos) propietario.historial_pagos = [];
          
          const pagoMes = parseFloat(row.pago_mes) || 0;
          const saldoAnterior = propietario.saldo_actual || 0;
          
          // Calcular total de este mes
          const totalFacturaMes = cuotaBase + 
                                 (parseFloat(row.cuota_extra) || 0) + 
                                 (parseFloat(row.sanciones) || 0) + 
                                 (parseFloat(row.acuerdo_pago) || 0);
          
          // Total a pagar (incluye saldo anterior)
          const totalAPagar = totalFacturaMes + saldoAnterior;
          
          // Calcular nuevo saldo despu√©s del pago
          const nuevoSaldo = Math.max(0, totalAPagar - pagoMes);
          
          // Obtener el mes anterior del historial si existe
          const mesAnterior = propietario.historial_pagos?.length > 0 
            ? propietario.historial_pagos[propietario.historial_pagos.length - 1].mes 
            : null;
          
          // Actualizar el propietario con el nuevo saldo
          propietario.saldo_actual = nuevoSaldo;
          propietario.historial_pagos.push({
            mes: nombreMes,
            facturado: totalAPagar,
            pagado: pagoMes,
            saldo: nuevoSaldo,
            fecha: new Date().toISOString().split('T')[0]
          });
          
          const factura = {
            numero: facturaInicial + procesadas,
            propietario: propietario.propietario || 'Sin nombre',
            manzana: propietario.manzana || '---',
            interior: propietario.interior || '---',
            direccion: `${propietario.manzana || ''} ${propietario.interior || ''}`.trim() || '---',
            total_factura_mes: totalFacturaMes,
            saldo_anterior: saldoAnterior,
            mes_anterior: mesAnterior,
            total_a_pagar: totalAPagar,
            pago_recibido: pagoMes,
            saldo_pendiente: nuevoSaldo,
            fecha: new Date().toISOString().split('T')[0],
            mes: nombreMes,
            cuota_extra: parseFloat(row.cuota_extra) || 0,
            sanciones: parseFloat(row.sanciones) || 0,
            acuerdo_pago: parseFloat(row.acuerdo_pago) || 0
          };
          facturasGeneradas.push(factura);
        }
        
        procesadas++;
        const porcentaje = (procesadas / total) * 100;
        document.getElementById('progressFill').style.width = porcentaje + '%';
        document.getElementById('progressText').innerText = `Procesando ${procesadas}/${total} facturas...`;
      } else {
        clearInterval(interval);
        document.getElementById('progressContainer').style.display = 'none';
        
        // Guardar saldos en SheetDB
        guardarSaldos().then(() => {
          const endTime = Date.now();
          const tiempoSegundos = ((endTime - startTime) / 1000).toFixed(1);
          
          mostrarResultadosProceso(tiempoSegundos);
          actualizarEstadisticas();
          
          setTimeout(() => {
            showTab('generar');
          }, 500);
        });
      }
    }, 30);
  }

  function mostrarResultadosProceso(tiempo) {
    const total = facturasGeneradas.reduce((sum, f) => sum + f.total_a_pagar, 0);
    
    document.getElementById('facturasGeneradas').innerText = facturasGeneradas.length;
    document.getElementById('totalFacturado').innerText = '$' + total.toLocaleString('es-CO');
    
    document.getElementById('resultadosProceso').style.display = 'block';
  }

  function actualizarEstadisticas() {
    document.getElementById('totalFacturasDisp').innerText = facturasGeneradas.length;
    document.getElementById('totalFacturasGenerar').innerText = facturasGeneradas.length;
    const total = facturasGeneradas.reduce((sum, f) => sum + f.total_a_pagar, 0);
    document.getElementById('totalValorDisp').innerText = '$' + total.toLocaleString('es-CO');
  }

  function cargarTablaFacturas() {
    const tbody = document.getElementById('facturasBody');
    tbody.innerHTML = '';
    
    if (facturasGeneradas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">No hay facturas generadas</td></tr>';
      return;
    }
    
    facturasGeneradas.slice(0, 50).forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${f.numero}</td>
        <td>${f.propietario || '---'}</td>
        <td>${f.manzana || '---'}</td>
        <td>${f.interior || '---'}</td>
        <td><strong>$${f.total_a_pagar.toLocaleString('es-CO')}</strong></td>
      `;
      tbody.appendChild(tr);
    });
    
    actualizarEstadisticas();
  }

  // ========== FUNCI√ìN PRINCIPAL: GENERAR FACTURAS COMPLETAS EN PDF ==========
  
  async function generarTodasLasFacturas() {
    if (facturasGeneradas.length === 0) {
      alert('No hay facturas para generar');
      return;
    }
    
    if (!confirm(`Se generar√°n ${facturasGeneradas.length} facturas en PDF dentro de un ZIP. ¬øContinuar?`)) {
      return;
    }
    
    // Mostrar progreso
    document.getElementById('generacionProgress').style.display = 'block';
    document.getElementById('generacionProgressFill').style.width = '0%';
    document.getElementById('generacionProgressText').innerHTML = 'Iniciando generaci√≥n...';
    
    const zip = new JSZip();
    const pdfFolder = zip.folder('facturas_para_imprimir');
    
    // Generar cada factura
    for (let i = 0; i < facturasGeneradas.length; i++) {
      const factura = facturasGeneradas[i];
      
      const porcentaje = ((i + 1) / facturasGeneradas.length) * 100;
      document.getElementById('generacionProgressFill').style.width = porcentaje + '%';
      document.getElementById('generacionProgressText').innerHTML = `Generando factura ${i+1} de ${facturasGeneradas.length}`;
      document.getElementById('generacionProgressDetalle').innerHTML = `Factura N¬∞ ${factura.numero} - ${factura.propietario}`;
      
      try {
        // Crear elemento HTML de la factura
        const elemento = document.createElement('div');
        elemento.innerHTML = generarFacturaCompleta(factura);
        elemento.style.position = 'absolute';
        elemento.style.left = '-9999px';
        elemento.style.top = '-9999px';
        elemento.style.width = '800px';
        elemento.style.backgroundColor = 'white';
        elemento.style.padding = '25px';
        elemento.style.boxSizing = 'border-box';
        elemento.style.overflow = 'visible';
        elemento.style.display = 'block';
        elemento.style.visibility = 'visible';
        document.body.appendChild(elemento);
        
        // Calcular altura REAL del contenido
        const alturaReal = Math.max(
          elemento.scrollHeight,
          elemento.offsetHeight,
          elemento.clientHeight
        );
        
        // Forzar que el elemento tenga su altura completa
        elemento.style.height = 'auto';
        elemento.style.minHeight = alturaReal + 'px';
        
        // Esperar a que se renderice completamente
        await new Promise(resolve => setTimeout(resolve, 800));
        
        // Generar canvas con opciones para capturar TODO
        const canvas = await html2canvas(elemento, {
          scale: 2,
          logging: false,
          allowTaint: false,
          useCORS: true,
          backgroundColor: '#ffffff',
          windowWidth: 900,
          windowHeight: alturaReal + 50,
          scrollY: -window.scrollY,
          scrollX: 0,
          x: 0,
          y: 0,
          width: elemento.offsetWidth,
          height: alturaReal,
          onclone: (clonedDoc, element) => {
            if (element) {
              element.style.height = alturaReal + 'px';
              element.style.overflow = 'visible';
              element.style.display = 'block';
            }
          }
        });
        
        // Crear PDF con las dimensiones exactas del canvas
        const imgData = canvas.toDataURL('image/png');
        const pdfWidth = canvas.width;
        const pdfHeight = canvas.height;
        
        const pdf = new jspdf.jsPDF({
          orientation: pdfHeight > pdfWidth ? 'portrait' : 'landscape',
          unit: 'px',
          format: [pdfWidth, pdfHeight]
        });
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        const pdfBlob = pdf.output('blob');
        
        // Agregar al ZIP con nombre descriptivo
        const nombrePDF = `FACTURA_${factura.numero}_${factura.manzana}_${factura.interior}.pdf`;
        pdfFolder.file(nombrePDF, pdfBlob);
        
        // Limpiar
        document.body.removeChild(elemento);
        
        // Peque√±a pausa para no saturar el navegador
        await new Promise(resolve => setTimeout(resolve, 500));
        
      } catch (error) {
        console.error(`Error en factura ${factura.numero}:`, error);
      }
    }
    
    // Agregar Excel de respaldo con la nueva informaci√≥n
    try {
      const excelData = facturasGeneradas.map(f => ({
        'Factura N¬∞': f.numero,
        'Propietario': f.propietario,
        'Manzana': f.manzana,
        'Interior': f.interior,
        'Saldo Anterior': f.saldo_anterior,
        'Total Mes': f.total_factura_mes,
        'Total a Pagar': f.total_a_pagar,
        'Pago Recibido': f.pago_recibido,
        'Saldo Pendiente': f.saldo_pendiente,
        'Mes': f.mes,
        'Fecha': f.fecha
      }));
      
      const ws = XLSX.utils.json_to_sheet(excelData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Facturas');
      const excelBlob = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      zip.file('lista_facturas.xlsx', excelBlob);
    } catch (error) {
      console.error('Error generando Excel:', error);
    }
    
    document.getElementById('generacionProgressText').innerHTML = 'Comprimiendo archivos...';
    
    // Generar ZIP
    try {
      const content = await zip.generateAsync({ 
        type: 'blob',
        compression: 'DEFLATE',
        compressionOptions: { level: 6 }
      });
      
      const fecha = new Date();
      const nombreArchivo = `TODAS_FACTURAS_${fecha.getFullYear()}-${(fecha.getMonth()+1).toString().padStart(2,'0')}-${fecha.getDate().toString().padStart(2,'0')}.zip`;
      
      saveAs(content, nombreArchivo);
      
      document.getElementById('generacionProgress').style.display = 'none';
      alert(`‚úÖ ¬°PROCESO COMPLETADO! Se generaron ${facturasGeneradas.length} facturas en PDF`);
      
    } catch (error) {
      console.error('Error generando ZIP:', error);
      document.getElementById('generacionProgress').style.display = 'none';
      alert('‚ùå Error al generar el ZIP. Intente de nuevo.');
    }
  }

  // ========== FUNCI√ìN CORREGIDA: GENERAR FACTURA COMPLETA ==========
  
  function generarFacturaCompleta(factura) {
    const fecha = new Date(factura.fecha + 'T12:00:00');
    const fechaFormateada = fecha.toLocaleDateString('es-CO', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
    
    return `
      <div style="font-family: 'Segoe UI', Arial, sans-serif; max-width: 750px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); border: 1px solid #e0e0e0;">
        <!-- Encabezado -->
        <div style="display: flex; align-items: center; gap: 25px; margin-bottom: 25px; border-bottom: 4px solid #1e3c5c; padding-bottom: 20px;">
          <img src="https://i.postimg.cc/2yb3MyY0/LOGO-BRISAS-DEL-NORTE.png" alt="Logo Brisas del Norte" style="max-width: 160px; max-height: 80px; object-fit: contain;">
          <div style="flex: 1;">
            <h1 style="color: #1e3c5c; margin: 0 0 8px 0; font-size: 1.5rem; font-weight: 700;">CONJUNTO RESIDENCIAL CERRADO BRISAS DEL NORTE</h1>
            <p style="color: #4a6d8c; margin: 0; font-size: 0.9rem; line-height: 1.4;">NIT: 807.003.209-3 - Personer√≠a Jur√≠dica No.1646 - Dic 17/1993</p>
          </div>
        </div>
        
        <!-- Informaci√≥n de la factura -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; background: #f0f7ff; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #cbdbe9;">
          <div><span style="color: #1e3c5c; font-weight: 700;">Factura N¬∞:</span> <span style="font-weight: 600;">${factura.numero}</span></div>
          <div><span style="color: #1e3c5c; font-weight: 700;">Fecha:</span> <span style="font-weight: 600;">${fechaFormateada}</span></div>
          <div><span style="color: #1e3c5c; font-weight: 700;">Per√≠odo:</span> <span style="font-weight: 600;">${factura.mes}</span></div>
          <div><span style="color: #1e3c5c; font-weight: 700;">Propietario:</span> <span style="font-weight: 600;">${factura.propietario}</span></div>
          <div><span style="color: #1e3c5c; font-weight: 700;">Manzana:</span> <span style="font-weight: 600;">${factura.manzana}</span></div>
          <div><span style="color: #1e3c5c; font-weight: 700;">Interior:</span> <span style="font-weight: 600;">${factura.interior}</span></div>
        </div>
        
        <!-- Detalle de facturaci√≥n -->
        <h2 style="color: #1e3c5c; font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #FFD700;">üìã DETALLE DE FACTURACI√ìN</h2>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background: #1e3c5c; color: white;">
              <th style="padding: 12px 15px; text-align: left; border-radius: 8px 0 0 0;">Concepto</th>
              <th style="padding: 12px 15px; text-align: right; border-radius: 0 8px 0 0;">Valor</th>
            </tr>
          </thead>
          <tbody>
            <!-- SALDO ANTERIOR (solo si existe) -->
            ${factura.saldo_anterior > 0 ? `
            <tr style="background: #fff3e0;">
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef;"><strong>Saldo anterior (${factura.mes_anterior || 'mes anterior'})</strong></td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef; text-align: right; font-weight: 600; color: #e65100;">$${factura.saldo_anterior.toLocaleString('es-CO')}</td>
            </tr>` : ''}
            
            <!-- Cuota de administraci√≥n del mes actual -->
            <tr style="background: #f9f9f9;">
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef;">Cuota de administraci√≥n (${factura.mes})</td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef; text-align: right; font-weight: 600;">$${100000..toLocaleString('es-CO')}</td>
            </tr>
            
            <!-- Cuota extra (si existe para el mes actual) -->
            ${factura.cuota_extra > 0 ? `
            <tr>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef;">Cuota extraordinaria</td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef; text-align: right; font-weight: 600;">$${factura.cuota_extra.toLocaleString('es-CO')}</td>
            </tr>` : ''}
            
            <!-- Sanciones (si existen para el mes actual) -->
            ${factura.sanciones > 0 ? `
            <tr style="background: #f9f9f9;">
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef;">Sanciones / Multas</td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef; text-align: right; font-weight: 600;">$${factura.sanciones.toLocaleString('es-CO')}</td>
            </tr>` : ''}
            
            <!-- Acuerdo de pago (si existe para el mes actual) -->
            ${factura.acuerdo_pago > 0 ? `
            <tr>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef;">Acuerdo de pago</td>
              <td style="padding: 12px 15px; border-bottom: 1px solid #e0e7ef; text-align: right; font-weight: 600;">$${factura.acuerdo_pago.toLocaleString('es-CO')}</td>
            </tr>` : ''}
            
            <!-- L√çNEA DE TOTAL A PAGAR -->
            <tr style="background: #e5eff9; font-weight: bold;">
              <td style="padding: 15px 15px; border-top: 2px solid #1e3c5c; border-bottom: 2px solid #1e3c5c;">TOTAL A PAGAR</td>
              <td style="padding: 15px 15px; border-top: 2px solid #1e3c5c; border-bottom: 2px solid #1e3c5c; text-align: right;">$${factura.total_a_pagar.toLocaleString('es-CO')}</td>
            </tr>
          </tbody>
        </table>
        
        <!-- Notas y condiciones -->
        <div style="margin-top: 20px; font-size: 0.8rem; color: #4a6d8c; border-top: 1px dashed #cbdbe9; padding-top: 20px;">
          <p style="margin: 5px 0;"><span style="font-weight: 700;">üìå NOTA IMPORTANTE:</span> Los pagos deben realizarse en BANCOLOMBIA AHORRO # 834-000000-00</p>
          <p style="margin: 5px 0;"><span style="font-weight: 700;">üí∞ Inter√©s por mora:</span> 2.5% mensual sobre saldos vencidos</p>
          <p style="margin: 5px 0;"><span style="font-weight: 700;">‚öñÔ∏è Cobro jur√≠dico:</span> A partir de tres (03) cuotas atrasadas</p>
          <p style="margin: 15px 0 5px 0; text-align: center; color: #1e3c5c; font-size: 0.9rem;">‚ú® ¬°Gracias por su puntualidad! ‚ú®</p>
        </div>
      </div>
    `;
  }

  function simularFacturacion() {
    if (novedadesData.length === 0) {
      alert('Primero cargue un archivo');
      return;
    }
    
    const totalFacturas = novedadesData.length;
    const conPagos = novedadesData.filter(r => parseFloat(r.pago_mes) > 0).length;
    const conCuotaExtra = novedadesData.filter(r => parseFloat(r.cuota_extra) > 0).length;
    const conSanciones = novedadesData.filter(r => parseFloat(r.sanciones) > 0).length;
    
    alert(`üîç SIMULACI√ìN:
    
üìÑ Archivo: ${document.getElementById('fileName').innerText}
üìä Total registros: ${totalFacturas}
üí∞ Con pagos: ${conPagos}
‚ûï Con cuota extra: ${conCuotaExtra}
‚ö†Ô∏è Con sanciones: ${conSanciones}

‚úÖ Archivo v√°lido para procesar (saldos desde Google Sheets)`);
  }
</script>
</body>
</html>